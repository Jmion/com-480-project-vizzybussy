<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
<script src="https://rawgit.com/Kcnarf/d3-distanceLimitedVoronoi/d3v4/distance-limited-voronoi.js"></script>





<!--Bootstrap CSS-->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>

<!-- Brush imports js-->
<script src="https://d3js.org/d3-color.v1.min.js"></script>
<script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
<script src="https://d3js.org/d3-ease.v1.min.js"></script>
<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
<script src="https://d3js.org/d3-timer.v1.min.js"></script>
<script src="https://d3js.org/d3-selection.v1.min.js"></script>
<script src="https://d3js.org/d3-transition.v1.min.js"></script>
<script src="https://d3js.org/d3-drag.v1.min.js"></script>
<script src="https://d3js.org/d3-brush.v1.min.js"></script>

<script src="assets/external/jquery/jquery.js"></script>
<link rel="stylesheet" href="./assets/css/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

<!--FONT-->
<link href="https://fonts.googleapis.com/css2?family=Indie+Flower&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">


<body>
    <div class="row">
        <div class="col-4 text-center align-bottom">
            <table style="width: 100%;">
                <tr>
                    <th>
                        Timeline control:
                        <button type="button" class="btn btn-light" id="timelineControl">Play</button>
                    </th>
                </tr>
                <tr>
                    <th>
                        Timeline control:
                        <button type="button" class="btn btn-light" id="speedIncrease">+</button>
                        <button type="button" class="btn btn-light" id="speedDecrease">-</button>
                    </th>
                </tr>
            </table>

        </div>
        <div class="col-4">
            <label for="genre-select">Genre</label>
            <select id="genre-select" class="form-control">
                <option selected value="all">All</option>
                <option value="Action">Action</option>
                <option value="Adventure">Adventure</option>
                <option value="Fantasy">Fantasy</option>
                <option value="Animation">Animation</option>
                <option value="Science Fiction">Science Fiction</option>
                <option value="Drama">Drama</option>
                <option value="Thriller">Thriller</option>
                <option value="Family">Family</option>
                <option value="Comedy">Comedy</option>
                <option value="History">History</option>
                <option value="War">War</option>
                <option value="Western">Western</option>
                <option value="Romance">Romance</option>
                <option value="Crime">Crime</option>
                <option value="Mystery">Mystery</option>
                <option value="Horror">Horror</option>
                <option value="Music">Music</option>
                <option value="Documentary">Documentary</option>
            </select>
        </div>
        <div class="col-4 ui-widget">
            <!--<label for="search">Search: </label>-->
            <input id="search" placeholder="Movie title">
            <button type="button" class="btn btn-light" >Search</button>
        </div>
    </div>

    <div class="row" style="margin-top: 1em;">
        <div class="col-lg-10 col-xl-8 offset-lg-1 offset-xl-2">

            <div id="year_selector" style="margin-bottom: 2em;">
                <div id="custom-handle" class="ui-slider-handle"></div>
            </div>
        </div>
    </div>

    <!--<div id="my_dataviz"></div>-->


    <!-- Create a div where the graph will take place -->
    <div class="row">
        <div class="col-md-9" id="graphContainer">
            <div id="my_dataviz"></div>
        </div>
        <div class="col-md-3" id="movie_info">
            <div id="tutorialDisplay">
                <div class="row">
                    <div class="col-sm-3">
                        <img src="/assets/img/haw-gestures-stroke.svg" style="width: 100%;max-width: 75px;" />
                    </div>
                    <div class="col-sm-8">
                        Hover over any of the bubbles to get more information about the movie. Click to select it. 
                    </div>
                </div>
                <p></p>
                <div class="row">
                    <div class="col-sm-3">
                        <img src="https://img.icons8.com/ios/100/000000/video.png"
                            style="width: 100%;max-width: 75px;" />
                    </div>
                    <div class="col-sm-8">
                        If you want to watch the movie trailer click on the thumbnail and start watching.
                    </div>
                </div>
                <p></p>
                <div class="row">
                    <div class="col-sm-3">
                        <img src="/assets/img/three.png" style="width: 100%;max-width: 75px;" />
                    </div>
                    <div class="col-sm-8">
                        The area of the circle indicates the production budget.
                    </div>
                </div>
                <div class="row" style="padding-top: 1em;">
                    <h5>Genres color code</h5>
                    <!--<img class="card-img-top mx-auto" src="assets/img/combined.png" style="width: 50vw;" alt="action">-->
                    <table style="width: 100%;">
                        <tr>
                            <th>
                                <img id="actionColorSel" class="card-img-top mx-auto" src="assets/img/action.png"
                                    alt="action">
                            </th>
                            <th>
                                <img id="adventureColorSel" class="card-img-top mx-auto" src="assets/img/adventure.png"
                                    alt="adventure">
                            </th>
                            <th>
                                <img id="comedyColorSel" class="card-img-top mx-auto" src="assets/img/comedy.png"
                                    alt="comedy">
                            </th>
                        </tr>
                        <tr>
                            <th>
                                <img id="crimeColorSel" class="card-img-top mx-auto" src="assets/img/crime.png"
                                    alt="crime">
                            </th>
                            <th>
                                <img id="dramaColorSel" class="card-img-top mx-auto" src="assets/img/drama.png"
                                    alt="drama">
                            </th>
                            <th>
                                <img id="familyColorSel" class="card-img-top mx-auto" src="assets/img/Family.png"
                                    alt="family">
                            </th>
                        </tr>
                        <tr>
                            <th>
                                <img id="fantasyColorSel" class="card-img-top mx-auto" src="assets/img/fantasy.png"
                                    alt="fantasy">
                            </th>
                            <th>
                                <img id="historyColorSel" class="card-img-top mx-auto" src="assets/img/history.png"
                                    alt="history">
                            </th>
                            <th>
                                <img id="horrorColorSel" class="card-img-top mx-auto" src="assets/img/horror.png"
                                    alt="horror">
                            </th>
                        </tr>
                        <tr>
                            <th>
                                <img id="musicColorSel" class="card-img-top mx-auto" src="assets/img/music.png"
                                    alt="music">
                            </th>
                            <th>
                                <img id="otherColorSel" class="card-img-top mx-auto" src="assets/img/other.png"
                                    alt="other">
                            </th>
                            <th>
                                <img id="romanceColorSel" class="card-img-top mx-auto" src="assets/img/romance.png"
                                    alt="romance">
                            </th>
                        </tr>
                        <tr>
                            <th>
                                <img id="sciFiColorSel" class="card-img-top mx-auto" src="assets/img/scienceFiction.png"
                                    alt="SciFi">
                            </th>
                            <th>
                                <img id="thrillerColorSel" class="card-img-top mx-auto" src="assets/img/thriller.png"
                                    alt="Thriller">
                            </th>
                            <th>
                                <img id="warColorSel" class="card-img-top mx-auto" src="assets/img/war.png" alt="War">
                            </th>
                        </tr>
                        <tr>

                            <th>
                                <img id="westernColorSel" class="card-img-top mx-auto" src="assets/img/western.png"
                                    alt="Western">
                            </th>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

    </div>

</body>

<script src="./assets/js/themoviedb.js" type="text/javascript"></script>
<script src="./assets/js/tmdb_helpers.js" type="text/javascript"></script>


<!--Jquerry ui custom handle-->
<style>
    body {
        font-family: 'Open Sans', sans-serif;
    }

    #custom-handle {
        width: 3em;
        height: 1.6em;
        top: 50%;
        margin-top: -.8em;
        text-align: center;
        line-height: 1.6em;
    }

    #movie_info::-webkit-scrollbar {
        width: 20px;
    }

    #movie_info::-webkit-scrollbar-track {
        border-radius: 10px;
    }

    #movie_info::-webkit-scrollbar-thumb {
        background: orange;
        border-radius: 10px;
    }

    #movie_info::-webkit-scrollbar-thumb:hover {
        background: #FF8C00;
    }

    #movie_info::-webkit-scrollbar-track-piece:end {
        background: transparent;
        margin-bottom: 10%;
    }

    #movie_info::-webkit-scrollbar-track-piece:start {
        background: transparent;
        margin-top: 10%;
    }
</style>



<script>
    //https://observablehq.com/@will-r-chase/scatter-plot
    // set the dimensions and margins of the graph
    var margin = { top: 40, right: 30, bottom: 80, left: 70 },
        width = $("#graphContainer").width() - margin.left - margin.right,
        height = Math.max($("#movie_info").height()+margin.top+margin.bottom+170 ,Math.min($(window).height(), $("#graphContainer").width()*0.5 ))- 170 - margin.top - margin.bottom;

    console.log("height: "+height+" width: "+ width)

    var config = {
        opacity_data_point_hover: "0.9",
        opacity_data_point_no_hover: "0.5",
        color_no_genre_data_point: "#444444",

        slider_max_year: 2016,
        slider_min_year: 1966,

        graph_background_color: "#FFFFFF",

        xaxis_min: 1000000,
        xaxis_max: 4000000000,
        yaxis_min: 1,
        yaxis_max: 1000,
        zaxis_min: 7000,
        zaxis_max: 1000000000,
    }

    genreColors = {
        Adventure: "#f0932b",
        Action: "#f9ca24",
        Comedy: "#6ab04c",
        Crime: "#22a6b3",
        Drama: "#7ed6df",
        Family: "#badc58",
        Fantasy: "#c7ecee",
        History: "#95afc0",
        Horror: "#686de0",
        Music: "#dff9fb",
        Romance: "#ff7979",
        "Science Fiction": "#ffbe76",
        Thriller: "#eb4d4b",
        War: "#f6e58d",
        Western: "#535c68"
    }

    //https://www.themoviedb.org/assets/2/v4/glyphicons/basic/glyphicons-basic-4-user-7de7dfcae838579a18f4eebc5b8847230d154718e481c5cd01c477cfcbc85993.svg

    //timer for auto advance of timeliine
    $("#timelineControl").attr("onclick", "timelineAction()")

    var myTimerSpeed = 450;
    var myTimelineTimer = null
    $("#speedIncrease").click(() => { myTimerSpeed = Math.max(myTimerSpeed - 100, 100); })
    $("#speedDecrease").click(() => { myTimerSpeed = Math.min(myTimerSpeed + 100, 1000); })


    var startTimelineTimer = () => {
        myTimelineTimer = setInterval(() => {
            $("#year_selector").slider("value", $("#year_selector").slider("value") + 1);
            clearInterval(myTimelineTimer)
            if ($("#year_selector").slider("value") == config.slider_max_year) {
                myTimelineTimer = null
                $("#timelineControl").text("Start")
            } else {
                startTimelineTimer()
            }
        }, myTimerSpeed)
    }
    var timelineAction = () => {
        if (myTimelineTimer == null) {
            $("#timelineControl").text("Stop")
            startTimelineTimer();
        } else {
            clearInterval(myTimelineTimer)
            myTimelineTimer = null
            $("#timelineControl").text("Start")
        }
    }


    // append the svg object to the body of the page
    var svg = d3.select("#my_dataviz")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)

    //background color
    svg.append("rect")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .style("fill", config.graph_background_color)


    svg = svg.append("g")
        .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")")
        .style("font", "20px Montserrat");

    // Add X axis
    var x = d3.scaleLog()
        .domain([config.xaxis_min, config.xaxis_max])//.nice()
        .range([0, width]);



    let tickLabels = ['1M', '2M', '3M', '4M', '5M', '6M', '7M', '8M', '9M', '10M', '20M', '30M', '40M', '50M', '60M', '70M', '80M', '90M', '100M', '200M', '300M', '400M', '500M', '600M', '700M', '800M', '900M', '1B', '2B', '3B'];
    svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x).tickFormat((d, i) => tickLabels[i]))
        .selectAll("text")
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", "rotate(-65)");;

    // Add Y axis
    var y = d3.scaleLog()
        .domain([config.yaxis_min, config.yaxis_max]).nice()
        .range([height, 0]);
    svg.append("g")
        .call(d3.axisLeft(y).tickFormat(d3.format(",d")));

    // Add a scale for bubble size
    var z = d3.scaleSqrt()
        .domain([config.zaxis_min, config.zaxis_max])
        .range([1, 60]);

    //title
    svg.append("text")
        .attr("class", "text")
        .attr("transform", "translate(" + (width / 2.5) + ",-" + margin.top / 2 + ")")
        .style("text-anchor", "left")
        .style("font-size", "1.2em")
        .text("Popularity vs Revenue")




    //x-axis label
    svg.append("text")
        .attr("class", "text")
        .attr("transform", "translate(" + (width / 2) + "," + (height + 60) + ")")
        .style("text-anchor", "middle")
        .style("font-size", "1em")
        .text("Revenue");

    //y-axis label
    svg.append("text")
        .attr("class", "text")
        .attr("transform", "translate(" + (0 - 40) + "," + (height / 2) + ")rotate(-90)")
        .style("text-anchor", "middle")
        .style("font-size", "1em")
        .text("Popularity");




    var keepMovieInfoDisplayed = { display: false }
    var displayMovieInfo = (d) => {
        if (d.datum != null) { d = d.datum }//can be called from the voronoiIntercationArea or the datapoint
        if (!keepMovieInfoDisplayed.display) {
            d3.selectAll(("#data_uid_" + d.id))
                .style("opacity", config.opacity_data_point_hover)
                .attr("stroke", "black")

            $("#tutorialDisplay").hide()

            d3.select("#tutorialDisplay")
                .attr("style", "display: none;")
            var movieDivInfo = d3.select("#movie_info")
                .append("div")
                .attr("class", "overflow-auto")
                .attr("style", "height:" + (height + margin.top + margin.bottom) + "px;")
                //.attr("style","border: 8px solid #f7f7f7;")
                .attr("id", "selectedMovieInfoDisplay")
                .append("div")
                .attr("style", "overflow-x: hidden;")

            var movieDiv = movieDivInfo
                .append("div")

            var moneyDiv = movieDivInfo
                .append("div")
                .attr("id", "budgetDiv")
                .attr("class", "row")

            var popularityDiv = movieDivInfo
                .append("div")
                .attr("class", "row")
                .attr("style", "margin-top:-0.6em")


            var creditsDiv = movieDivInfo
                .append("div")
                .attr("class", "row")
                .attr("id", "creditMovieDiv")

            movieDiv
                .append("div")
                .attr("class", "row")
                .append("div")
                .attr("class", "col")
                .append("h3")
                .attr("class", "d-flex justify-content-center text-center")
                .text(d.original_title)
            movieDiv
                .append("div")
                .attr("class", "row")
                .append("div")
                .attr("class", "col")
                .append("h5")
                .attr("class", "d-flex justify-content-center text-center")
                .text(d.realease_year)


            movieDiv
                .append("div")
                .attr("class", "row")
                .append("div")
                .attr("class", "cols-sm-1 center-block")
                .append('a')
                .attr("id", "movieInfoImgLink")
                .append("div")
                .attr("class", "d-flex justify-content-center")
                .append("img")
                .attr('class', "img-fluid rounded")
                .attr("style", "width:50%;")
                .attr("id", "movieInfoImg")

            movieDiv
                .append("div")
                .attr("class", "row")
                .append("div")
                .attr("class", "cols-sm-1 center-block")
                .append('a')
                .attr("id", "movieInfoYoutubeLink")
                .append("div")
                .attr("class", "d-flex justify-content-center")
                .append("img")
                .attr('class', "img-fluid rounded")
                .attr("style", "width:15%;")
                .attr("src", "./assets/img/youtube.svg")

            setMovieImage("#movieInfoImg", d.id, movieInfoImgLink = "#movieInfoImgLink", creditMovieDiv = "#creditMovieDiv", movieInfoYoutubeLink = "#movieInfoYoutubeLink", verbose = true)

            moneyDiv
                .append("div")
                .attr("class", "col-sm-4")
                .append("img")
                .attr("class", "img-responsive mx-auto d-block")
                .attr("src", "https://img.icons8.com/bubbles/75/000000/money.png")

            moneyDiv
                .append("div")
                .attr("class", "col-sm-8")
                .append("div")
                .attr("class", "container d-flex h-100")
                .append("div")
                .attr("class", "row align-self-center")
                .html("<div style='font-size: 80%;'>BUDGET : " + customCurrencyFormatter(d.budget) + "<p>" + "REVENUE : " + customCurrencyFormatter(d.revenue) + "</div>")

            popularityDiv
                .append("div")
                .attr("class", "col-sm-4")
                .append("img")
                .attr("class", "img-responsive mx-auto d-block")
                .attr("style", "padding-bottom:1em")
                .attr("src", "https://img.icons8.com/bubbles/75/000000/crowd.png")

            popularityDiv
                .append("div")
                .attr("class", "col-sm-8")
                .append("div")
                .attr("class", "container d-flex h-100")
                .append("div")
                .attr("class", "row  align-self-center")
                .html("<div style='font-size: 80%;'>POPULARITY : " + parseFloat(d.popularity).toFixed(1) + "</div>")


        }
        //console.log(typeof (d.id))
        //.text("revenue : " + d.revenue + " ; popularity : " + d.popularity + " ; budget: " + d.budget + " ; title : " + d.original_title + " ; genre : " + d.genres + " ; realease year : " + d.realease_year)
    }
    var removeMovieInfo = (d) => {
        if (d.datum != null) { d = d.datum } //can be called from the voronoiIntercationArea or the datapoint

        if (!keepMovieInfoDisplayed.display) {

            $("div[id^='selectedMovieInfoDisplay']").each(function () {
                this.remove()
            });

            //$("#movie_info").css("font-size", "0.6em")

            $("#tutorialDisplay").show() //redisplaying the tutorial

            d3.selectAll(("#data_uid_" + d.id))
                .style("opacity", config.opacity_data_point_no_hover)
                .attr("stroke", "none")


        }
    }





    var permanentMovieDisplay = (d) => {
        if (d.datum != null) { d = d.datum }
        console.log(d.id)
        if (keepMovieInfoDisplayed.d == null) {
            keepMovieInfoDisplayed.display = !keepMovieInfoDisplayed.display
            keepMovieInfoDisplayed.d = d
            if (!keepMovieInfoDisplayed.display) {
                removeMovieInfo(keepMovieInfoDisplayed.d)
                delete keepMovieInfoDisplayed.d
            } else {
                displayMovieInfo(keepMovieInfoDisplayed.d)
            }

        } else {
            keepMovieInfoDisplayed.display = !keepMovieInfoDisplayed.display
            removeMovieInfo(keepMovieInfoDisplayed.d)
            displayMovieInfo(d)
            keepMovieInfoDisplayed.d = d
        }
        console.log(keepMovieInfoDisplayed)
    }

    //Read the data
    d3.csv("data/bubbleData.csv", function (data) {


        //genre change when clicking on color selector
        function setGenre(genreSelected) {
            $("#genre-select").val(genreSelected)
            renderData(data)
        }

        //On click listeners for color selectors
        function addOnClickGenreListeners() {
            $("#actionColorSel").click(() => { setGenre("Action") })
            $("#adventureColorSel").click(() => { setGenre("Adventure") })
            $("#comedyColorSel").click(() => { setGenre("Comedy") })
            $("#crimeColorSel").click(() => { setGenre("Crime") })
            $("#dramaColorSel").click(() => { setGenre("Drama") })
            $("#familyColorSel").click(() => { setGenre("Family") })
            $("#fantasyColorSel").click(() => { setGenre("Fantasy") })
            $("#historyColorSel").click(() => { setGenre("History") })
            $("#horrorColorSel").click(() => { setGenre("Horror") })
            $("#musicColorSel").click(() => { setGenre("Music") })
            $("#otherColorSel").click(() => { setGenre("all") })
            $("#romanceColorSel").click(() => { setGenre("Romance") })
            $("#sciFiColorSel").click(() => { setGenre("Science Fiction") })
            $("#thrillerColorSel").click(() => { setGenre("Thriller") })
            $("#warColorSel").click(() => { setGenre("War") })
            $("#westernColorSel").click(() => { setGenre("Western") })
        }
        addOnClickGenreListeners()


        //year slider
        $(function () {
            var handle = $("#custom-handle");
            $("#year_selector").slider({
                //range: "max",
                create: function () {
                    handle.text($(this).slider("value"));
                },
                //animate: "fast",
                min: config.slider_min_year,
                max: config.slider_max_year,
                value: 2000,
                change: function (event, ui) {
                    if (ui.value != null) { //called from search
                        console.log(ui.value);
                        handle.text(ui.value);
                        renderData(data)
                    }
                },
                slide: function (event, ui) {
                    console.log(ui.value);
                    handle.text(ui.value);
                }
            })
        });





        //list of all movies in dataset
        var movies = []
        for (const d in data) {
            movies.push({ label: data[d].original_title, data: data[d] })
        }

        //auto complete search bar
        $(function () {
            var updateFunc = function (event, ui) {
                if (ui.item == null) {
                    this.value = ""
                    alert("Movie title not found. Please select on from the drop down.")
                } else {
                    console.log(ui.item.data)
                    $("#genre-select").val("all")
                    $("#year_selector").slider("value", ui.item.data.realease_year)
                    $("#custom-handle").text(ui.item.data.realease_year)
                    delete keepMovieInfoDisplayed.d
                    keepMovieInfoDisplayed.display = false
                    $("div[id^='selectedMovieInfoDisplay']").each(function () {
                        this.remove()
                    });
                    displayMovieInfo(ui.item.data)
                    permanentMovieDisplay(ui.item.data)
                }
            }
            $("#search").autocomplete({
                source: movies,
                minLength: 3,
                delay: 0,
                change: updateFunc,
                select: updateFunc
            });
        });


        //drop down genre selection
        d3.select('#genre-select').on('change', function () {
            var f = document.getElementById('genre-select')
            selected_genre = f.options[f.selectedIndex].value
            console.log(selected_genre)
            renderData(data)
        })


        renderData(data)
    })

    //currency formater
    const usdFormatter = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
    })

    //Million and billion detector and shortener
    var customCurrencyFormatter = (value) => {
        if (value / 1e9 > 1) {
            return usdFormatter.format(value / 1e9) + "B"
        }
        else if (value / 1e6) {
            return usdFormatter.format(value / 1e6) + "M"
        }
        return usdFormatter.format(value)
    }


    var renderData = (data) => {


        var genre_selected = $("select#genre-select").val();

        var filterFuncGenre = (dat) => { return dat }
        if (genre_selected != "all") {
            filterFuncGenre = (dat) => { return dat.filter((d) => { return d.genres === genre_selected }) }
        }

        var filterFuncYear = (d) => { return d.realease_year == fromYear }
        var filterWithinDisplayRangs = (d) => { return d.revenue > config.xaxis_min && d.revenue < config.xaxis_max && d.popularity > config.yaxis_min && d.popularity < config.yaxis_max }

        var fromYear = $("#year_selector").slider("option", "value")
        var filterFunc = (dat) => { return filterFuncGenre(dat).filter(filterFuncYear).filter(filterWithinDisplayRangs) }


        local_config = {
            action_when_entering_data_point: displayMovieInfo,
            action_when_leaving_data_point: removeMovieInfo,
            action_when_clicking_data_point: permanentMovieDisplay
        }

        // Removing previously drawn elements
        d3.selectAll("#dotGroup")
            .remove()

        d3.selectAll("#dotIntercationRegion")
            .remove()

        d3.selectAll("#yearText")
            .remove()

        svg.append("text")
            .attr("id", "yearText")
            .attr("class", "text")
            .attr("transform", "translate(" + (width / 2) + "," + (height / 2) + ")")
            .style("text-anchor", "middle")
            .style("font-size", "10em")
            .style("opacity", "0.2")
            .text(fromYear);

        //drawing data point
        svg.append('g')
            .attr("id", "dotGroup")
            .selectAll("dot")
            .data(filterFunc(data))
            .enter()
            .append("circle")
            .attr("id", function (d) { return "data_uid_" + d.id }) //used to change the style of that point when mouse enters and leaves
            .attr("class", function (d) { return d.genres })
            .attr("cx", function (d) { return x(d.revenue); })
            .attr("cy", function (d) { return y(d.popularity); })
            .attr("r", function (d) { return z(d.budget); })
            .style("fill", function (d) {
                return genreColors[d.genres] == undefined ? config.color_no_genre_data_point : genreColors[d.genres]
            })
            .style("opacity", config.opacity_data_point_no_hover)
            .on("mouseover", local_config.action_when_entering_data_point)
            .on("mouseleave", local_config.action_when_leaving_data_point)
            .on("click", local_config.action_when_clicking_data_point)


        //calculating Voronoi intercation area
        let limVoronoi = d3.distanceLimitedVoronoi()
            .x(d => x(d.revenue))
            .y(d => y(d.popularity))
            .limit(25)


        svg.append("g")
            .attr("id", "dotIntercationRegion")
            .selectAll(".interactive-region")
            .data(limVoronoi(filterFunc(data)))
            .enter()
            .append("path")
            .attr("d", function (d) { return d.path; })
            .style("fill", "none")
            //.style("stroke", "steelblue")
            //.style("opacity", "0.1")
            .style("pointer-events", "all")
            .on('mouseenter', local_config.action_when_entering_data_point)
            .on('mouseout', local_config.action_when_leaving_data_point)
            .on("click", local_config.action_when_clicking_data_point)
    }

</script>